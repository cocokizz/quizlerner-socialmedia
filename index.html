<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktives Social Media Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        /* Setup Screen Styles */
        .setup-screen h1 {
            font-size: 2.5rem;
            color: #059669;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
        }
        .setup-screen .subtitle {
            text-align: center;
            color: #475569;
            margin-bottom: 24px;
        }
        .filter-container {
            margin-bottom: 8px;
            padding: 16px;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .filter-container h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 8px;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .filter-button {
            padding: 4px 10px;
            font-size: 0.875rem;
            background-color: #f1f5f9;
            color: #334155;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .filter-button:hover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        .filter-button.active {
            background-color: #10b981;
            color: #ffffff;
            border-color: #059669;
        }
        .start-quiz-btn {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            background-color: #059669;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 24px;
            transition: background-color 0.2s ease;
        }
        .start-quiz-btn:hover {
            background-color: #047857;
        }
        .start-quiz-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Learning Progress Styles */
        .learning-progress-section {
            margin-top: 2rem;
        }
        .learning-progress-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            color: #334155;
        }
        .progress-tile {
            background-color: #fff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .progress-tile h4 {
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }
        .progress-tile .percentage {
            font-size: 2.25rem;
            font-weight: 800;
            color: #059669;
        }
        .progress-bar-container {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }
        .progress-bar {
            height: 100%;
            background-color: #10b981;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .instructions {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f1f5f9;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .instructions h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .instructions p {
            color: #475569;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .instructions strong {
            color: #065f46;
        }
        /* Quiz Screen Styles */
        .quiz-screen {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .progress-indicator {
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            background-color: #f0fdf4;
            padding: 8px 16px;
            border-radius: 8px;
        }
        .timer.low-time {
            color: #dc2626;
            background-color: #fef2f2;
        }
        .question-container .question-name {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 8px;
        }
        .question-container .question-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 24px;
        }
        .answers-form .answer-option {
            display: block;
            background-color: #f8fafc;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .answers-form .answer-option:hover {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .answers-form .answer-option input {
            margin-right: 12px;
        }
        .answers-form .answer-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
            font-weight: 600;
        }
        .answers-form .answer-option.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
            font-weight: 600;
        }
        /* New styles for select box */
        .answers-form select {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        .answers-form select:focus {
            border-color: #10b981;
            outline: none;
        }
        .answers-form option {
            padding: 8px;
        }
        .answers-form option.correct {
            background-color: #dcfce7;
            color: #15803d;
        }
        .answers-form option.incorrect {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
        }
        .nav-btn, .submit-btn {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .nav-btn {
            background-color: #e2e8f0;
            color: #334155;
        }
        .nav-btn:hover {
            background-color: #cbd5e1;
        }
        .nav-btn:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }
        .submit-btn {
            background-color: #3b82f6;
            color: white;
        }
        .submit-btn:hover {
            background-color: #2563eb;
        }
        .submit-btn:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        /* Results Screen Styles */
        .results-screen {
            text-align: center;
            background-color: #ffffff;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .results-screen h2 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #059669;
            margin-bottom: 16px;
        }
        .results-screen .score {
            font-size: 1.5rem;
            color: #334155;
            margin-bottom: 32px;
        }
        .results-screen .restart-btn {
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background-color: #3b82f6;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .results-screen .restart-btn:hover {
            background-color: #2563eb;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Screen 1: Setup -->
        <div id="setupScreen" class="setup-screen">
            <h1>Social Media Quiz</h1>
            <p class="subtitle">Wählen Sie den Modus und die Fragen aus, die Sie üben möchten.</p>
            <div class="filter-container">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6">
                    <!-- Column 1: Modus -->
                    <div>
                        <h3>Modus:</h3>
                        <div class="filter-buttons" id="modeFilterButtons">
                            <button class="filter-button active" data-filter-type="mode" data-filter-value="practice">Übungsmodus</button>
                            <button class="filter-button" data-filter-type="mode" data-filter-value="exam">Prüfungsmodus (100 Fragen)</button>
                        </div>
                    </div>
                    <!-- Column 2: Typ -->
                    <div data-practice-filter>
                        <h3>Typ:</h3>
                        <div class="filter-buttons" id="typeFilterButtons">
                            <button class="filter-button active" data-filter-type="type" data-filter-value="Alle">Alle</button>
                            <button class="filter-button" data-filter-type="type" data-filter-value="Musterprüfung">Musterprüfung</button>
                            <button class="filter-button" data-filter-type="type" data-filter-value="Quiz LF">Quiz LF</button>
                        </div>
                    </div>
                    <!-- Column 3: LF -->
                    <div data-practice-filter>
                        <h3>LF:</h3>
                        <div class="filter-buttons" id="sectionFilterButtons">
                            <!-- Dynamic buttons -->
                        </div>
                    </div>
                    <!-- Column 4: Anzahl -->
                    <div data-practice-filter>
                        <h3>Anzahl der Fragen:</h3>
                        <div class="filter-buttons" id="questionCountFilterButtons">
                             <button class="filter-button" data-filter-type="count" data-filter-value="10">10</button>
                             <button class="filter-button" data-filter-type="count" data-filter-value="25">25</button>
                             <button class="filter-button" data-filter-type="count" data-filter-value="50">50</button>
                             <button class="filter-button active" data-filter-type="count" data-filter-value="Alle" id="allQuestionsBtn">Alle</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="startQuizBtn" class="start-quiz-btn">Quiz starten</button>
            <!-- Learning Progress Section -->
            <div class="learning-progress-section">
                <h2>Dein Lernstand</h2>
                <div id="progressTiles" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Progress tiles will be generated by JavaScript -->
                </div>
            </div>
            
            <div class="instructions">
                <h3>Informationen zur Bedienung</h3>
                <p><strong>Übungsmodus:</strong> Wählen Sie gezielt Fragen nach Typ, Lernfeld (LF) und Anzahl aus, um bestimmte Themen zu trainieren.</p>
                <p><strong>Prüfungsmodus:</strong> Startet eine Prüfungssimulation mit 100 zufällig ausgewählten Fragen aus dem gesamten Pool.</p>
                <p><strong>Intelligentes Lernen:</strong> Das System merkt sich alle Fragen, die Sie falsch beantworten. Im nächsten Prüfungsmodus werden diese Fragen automatisch bevorzugt, damit Sie sie gezielt wiederholen können. Sobald Sie eine dieser Fragen richtig beantworten, wird sie aus der "Wiederholungsliste" entfernt. <strong>(Hinweis: Diese Funktion speichert die Daten nur in der aktuellen Browser-Sitzung. Ein Neuladen der Seite setzt den Speicher zurück.)</strong></p>
            </div>
        </div>
        <!-- Screen 2: Quiz -->
        <div id="quizScreen" class="quiz-screen hidden">
            <div class="quiz-header">
                <div id="progressIndicator" class="progress-indicator">Frage 1 / 10</div>
                <div id="timer" class="timer">01:00</div>
            </div>
            <div id="questionContainer" class="question-container">
                <p class="question-name" id="questionName"></p>
                <h2 class="question-text" id="questionText"></h2>
                <form id="answersForm" class="answers-form"></form>
            </div>
            <div class="quiz-navigation">
                <button id="prevBtn" class="nav-btn">Zurück</button>
                <button id="submitBtn" class="submit-btn">Antwort bestätigen</button>
                <button id="nextBtn" class="nav-btn">Weiter</button>
            </div>
        </div>
        <!-- Screen 3: Results -->
        <div id="resultsScreen" class="results-screen hidden">
            <h2>Quiz beendet!</h2>
            <p id="score" class="score">Du hast 8 von 10 Fragen richtig beantwortet.</p>
            <button id="restartBtn" class="restart-btn">Neues Quiz starten</button>
        </div>
    </div>
    
    <!-- Load questions from external file -->
    <script src="questions.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const setupScreen = document.getElementById('setupScreen');
            const quizScreen = document.getElementById('quizScreen');
            const resultsScreen = document.getElementById('resultsScreen');
            const modeFilterButtons = document.getElementById('modeFilterButtons');
            const typeFilterButtons = document.getElementById('typeFilterButtons');
            const sectionFilterButtons = document.getElementById('sectionFilterButtons');
            const questionCountFilterButtons = document.getElementById('questionCountFilterButtons');
            const startQuizBtn = document.getElementById('startQuizBtn');
            const progressIndicator = document.getElementById('progressIndicator');
            const timerEl = document.getElementById('timer');
            const questionNameEl = document.getElementById('questionName');
            const questionTextEl = document.getElementById('questionText');
            const answersForm = document.getElementById('answersForm');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const scoreEl = document.getElementById('score');
            const restartBtn = document.getElementById('restartBtn');
            const allQuestionsBtn = document.getElementById('allQuestionsBtn');
            const progressTilesContainer = document.getElementById('progressTiles');
            
            // --- STATE ---
            const INCORRECT_QUESTIONS_KEY = 'incorrectlyAnsweredQuizQuestions';
            const QUESTION_PROGRESS_KEY = 'questionProgress';
            let allQuestions = [];
            let quizQuestions = [];
            let currentQuestionIndex = 0;
            let userAnswers = {};
            let timerInterval;
            let timeLeft = 60;
            let quizMode = 'practice'; // 'practice' or 'exam'
            let selectedType = 'Alle';
            let selectedSection = 'Alle';
            let selectedQuestionCount = 'Alle';

            // --- FUNCTIONS ---
            function getProgressData() {
                const stored = localStorage.getItem(QUESTION_PROGRESS_KEY);
                return stored ? JSON.parse(stored) : {};
            }

            function updateProgressData() {
                const progressData = getProgressData();
                let incorrect = new Set(JSON.parse(localStorage.getItem(INCORRECT_QUESTIONS_KEY) || '[]'));
                
                Object.keys(userAnswers).forEach(index => {
                    const question = quizQuestions[index];
                    const answer = userAnswers[index];
                    
                    progressData[question.question] = answer.isCorrect ? 'correct' : 'incorrect';
                    if (answer.isCorrect) {
                        incorrect.delete(question.question);
                    } else {
                        incorrect.add(question.question);
                    }
                });
                localStorage.setItem(QUESTION_PROGRESS_KEY, JSON.stringify(progressData));
                localStorage.setItem(INCORRECT_QUESTIONS_KEY, JSON.stringify(Array.from(incorrect)));
                calculateAndDisplayProgress();
            }

            function shuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }
            
            /**
             * Parses the question name to extract its type and section (Lernfeld).
             * @param {string} name The full name of the question.
             * @returns {{type: string, section: string}} An object containing the extracted type and section.
             */
            function parseQuestionName(name) {
                let type = 'Sonstige'; // Default type
                let section = 'Sonstige'; // Default section

                const musterpruefungMatch = name.match(/Musterprüfung\s+([A-Z])(?:\.\d+)?/i);
                if (musterpruefungMatch) {
                    type = 'Musterprüfung';
                    section = musterpruefungMatch[1].toUpperCase();
                } else {
                    const quizLfMatch = name.match(/Quiz LF\s+([A-Z])(?:\.\d+)?/i);
                    if (quizLfMatch && quizLfMatch[1]) {
                        type = 'Quiz LF';
                        section = quizLfMatch[1].toUpperCase();
                    } else {
                         // For other names like "Wissenstest", keep type as Quiz LF but section as Sonstige
                        type = 'Quiz LF';
                        section = 'Sonstige';
                    }
                }
                return { type, section };
            }

            /**
             * Initializes the question data by loading from the external file.
             * The deduplication logic has been removed.
             */
            function initializeData() {
                // Check if questions are loaded from external file
                if (typeof initialRawQuestions === 'undefined') {
                    alert("Fehler: Die Datei 'questions.js' konnte nicht geladen werden.");
                    return;
                }
                
                // --- NO DEDUPLICATION ---
                // The deduplication logic has been removed as requested.
                // All questions from initialRawQuestions will now be loaded.
                allQuestions = initialRawQuestions.map(q => {
                    return { ...q, ...parseQuestionName(q.name) };
                });

                setupFilters();
                updateAllQuestionsCount();
                calculateAndDisplayProgress();
            }

            function setupFilters() {
                // Collect all unique sections present in the data
                let uniqueSections = [...new Set(allQuestions.map(q => q.section))];
                // Filter out 'Sonstige' from the sections that will be displayed as filter buttons and sort them
                const sectionsToDisplay = uniqueSections.filter(s => s !== 'Sonstige').sort();

                // Always start with 'Alle', then add the sorted, filtered sections
                const sections = ['Alle', ...sectionsToDisplay];

                sectionFilterButtons.innerHTML = sections.map(section =>
                    `<button class="filter-button ${section === 'Alle' ? 'active' : ''}" data-filter-type="section" data-filter-value="${section}">${section}</button>`
                ).join('');
            }
            
            function updateAllQuestionsCount() {
                const filteredQuestions = allQuestions.filter(q => {
                    const typeMatch = selectedType === 'Alle' || q.type === selectedType;
                    const sectionMatch = selectedSection === 'Alle' || q.section === selectedSection;
                    return typeMatch && sectionMatch;
                });
                const count = filteredQuestions.length;
                allQuestionsBtn.textContent = `Alle (${count})`;
            }

            function calculateAndDisplayProgress() {
                const progressData = getProgressData();
                // Dynamically get all sections present in the data for progress tiles
                const sectionsForProgress = [...new Set(allQuestions.map(q => q.section))].sort();
                
                progressTilesContainer.innerHTML = ''; // Clear existing tiles
                let totalCorrect = 0;
                let totalAnswered = 0;

                sectionsForProgress.forEach(lf => {
                    // Only create progress tiles for sections that are not 'Sonstige'
                    if (lf === 'Sonstige') return;

                    const lfQuestions = allQuestions.filter(q => q.section === lf);
                    if (lfQuestions.length === 0) return; // Skip if no questions for this section

                    const answeredLfQuestions = lfQuestions.filter(q => progressData.hasOwnProperty(q.question));
                    const correctLfQuestions = answeredLfQuestions.filter(q => progressData[q.question] === 'correct');
                    
                    const percentage = answeredLfQuestions.length > 0 ? Math.round((correctLfQuestions.length / answeredLfQuestions.length) * 100) : 0;
                    totalCorrect += correctLfQuestions.length;
                    totalAnswered += answeredLfQuestions.length;

                    const tile = `
                        <div class="progress-tile">
                            <h4>LF ${lf}</h4>
                            <div class="percentage">${percentage}%</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${percentage}%;"></div>
                            </div>
                        </div>`;
                    progressTilesContainer.innerHTML += tile;
                });
                // Gesamt tile
                const gesamtPercentage = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
                const gesamtTile = `
                    <div class="progress-tile">
                        <h4>Gesamt</h4>
                        <div class="percentage">${gesamtPercentage}%</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${gesamtPercentage}%;"></div>
                        </div>
                    </div>`;
                progressTilesContainer.innerHTML += gesamtTile;
            }

            function handleFilterClick(e) {
                const button = e.target.closest('.filter-button');
                if (!button) return;
                const { filterType, filterValue } = button.dataset;
                if (filterType === 'mode') {
                    quizMode = filterValue;
                    document.querySelectorAll('[data-practice-filter]').forEach(el => el.classList.toggle('hidden', quizMode === 'exam'));
                } else if (filterType === 'type') {
                    selectedType = filterValue;
                } else if (filterType === 'section') {
                    selectedSection = filterValue;
                } else if (filterType === 'count') {
                    selectedQuestionCount = filterValue;
                }
                button.parentElement.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                if (filterType === 'type' || filterType === 'section') {
                    updateAllQuestionsCount();
                }
            }

            function startQuiz() {
                let filteredQuestions;
                if (quizMode === 'exam') {
                    const incorrectTexts = JSON.parse(localStorage.getItem(INCORRECT_QUESTIONS_KEY) || '[]');
                    const incorrectQuestions = allQuestions.filter(q => incorrectTexts.includes(q.question));
                    
                    const remainingQuestions = allQuestions.filter(q => !incorrectTexts.includes(q.question));
                    const shuffledRemaining = shuffle(remainingQuestions);
                    const needed = 100 - incorrectQuestions.length;
                    quizQuestions = [...incorrectQuestions, ...shuffledRemaining.slice(0, Math.max(0, needed))];
                    
                } else {
                    filteredQuestions = allQuestions.filter(q => {
                        const typeMatch = selectedType === 'Alle' || q.type === selectedType;
                        const sectionMatch = selectedSection === 'Alle' || q.section === selectedSection;
                        return typeMatch && sectionMatch;
                    });
                    let shuffled = shuffle(filteredQuestions);
                    if (selectedQuestionCount !== 'Alle') {
                        quizQuestions = shuffled.slice(0, parseInt(selectedQuestionCount, 10));
                    } else {
                        quizQuestions = shuffled;
                    }
                }
                if (quizQuestions.length === 0) {
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center';
                    messageBox.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                            <p class="mb-4 text-lg font-semibold">Keine Fragen für die ausgewählten Filter gefunden. Bitte Auswahl ändern.</p>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="this.parentElement.parentElement.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    return;
                }
                currentQuestionIndex = 0;
                userAnswers = {};
                setupScreen.classList.add('hidden');
                resultsScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                displayQuestion();
            }

            function displayQuestion() {
                clearInterval(timerInterval);
                const question = quizQuestions[currentQuestionIndex];
                const userAnswer = userAnswers[currentQuestionIndex];
                progressIndicator.textContent = `Frage ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
                questionNameEl.textContent = question.name;
                questionTextEl.textContent = question.question;
                const isMultipleChoice = question.correct.length > 1;

                if (Array.isArray(question.answers) && typeof question.answers[0] === 'object' && question.answers[0] !== null) {
                    // Handle matching questions (object-based answers)
                    const answerParts = question.answers.map(ansObj => Object.keys(ansObj)[0]);
                    const correctParts = question.correct.map(corrObj => Object.values(corrObj)[0]);
                    
                    let formHTML = '<div class="grid grid-cols-2 gap-4">';
                    answerParts.forEach((part, index) => {
                        formHTML += `<div><label class="block font-semibold mb-1">${part}</label><select data-part="${part}" class="w-full p-2 border rounded">`;
                        // Provide shuffled options for matching
                        const options = shuffle([...correctParts]);
                        options.forEach(option => {
                            formHTML += `<option value="${option}">${option}</option>`;
                        });
                        formHTML += `</select></div>`;
                    });
                    formHTML += '</div>';
                    answersForm.innerHTML = formHTML;

                } else if (isMultipleChoice) {
                    const optionsHTML = question.answers.map(answer => `<option value="${answer}">${answer}</option>`).join('');
                    answersForm.innerHTML = `
                        <label for="multi-select-box" class="block mb-2 font-semibold text-slate-700">Wählen Sie alle korrekten Antworten aus (halten Sie Strg/Cmd gedrückt):</label>
                        <select multiple id="multi-select-box" class="w-full p-2 h-48">${optionsHTML}</select>`;
                } else {
                    answersForm.innerHTML = question.answers.map((answer, index) => `
                        <label for="answer-${index}" class="answer-option" id="label-answer-${index}">
                            <input type="radio" name="answer" id="answer-${index}" value="${answer}">${answer}
                        </label>`).join('');
                }

                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = true;
                submitBtn.disabled = false;
                if (userAnswer) {
                    showAnswerResult(userAnswer);
                    // Pre-fill user's previous answer
                } else {
                    startTimer();
                }
            }
            
            function startTimer() {
                timeLeft = 60;
                timerEl.textContent = `01:00`;
                timerEl.classList.remove('low-time');
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const seconds = (timeLeft % 60).toString().padStart(2, '0');
                    timerEl.textContent = `${minutes}:${seconds}`;
                    if (timeLeft <= 10) timerEl.classList.add('low-time');
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        submitAnswer(true);
                    }
                }, 1000);
            }

            function submitAnswer(isTimeUp = false) {
                clearInterval(timerInterval);
                const question = quizQuestions[currentQuestionIndex];
                let selectedOptions = [];
                let isCorrect = false;

                const matchingSelects = answersForm.querySelectorAll('select:not(#multi-select-box)');
                if (matchingSelects.length > 0) {
                    // Logic for matching questions
                    let allMatched = true;
                    const tempAnswers = {};
                    matchingSelects.forEach(select => {
                        const part = select.dataset.part;
                        const selectedValue = select.value;
                        tempAnswers[part] = selectedValue;
                        const correctObj = question.correct.find(c => Object.keys(c)[0] === part);
                        if (!correctObj || correctObj[part] !== selectedValue) {
                            allMatched = false;
                        }
                    });
                    isCorrect = allMatched;
                    selectedOptions = [tempAnswers]; // Store the map of selections
                } else {
                    // Logic for multiple choice or single choice
                    const multiSelect = answersForm.querySelector('#multi-select-box');
                    if (multiSelect) {
                        selectedOptions = Array.from(multiSelect.selectedOptions).map(option => option.value);
                    } else {
                        const checkedInput = answersForm.querySelector('input:checked');
                        if (checkedInput) selectedOptions = [checkedInput.value];
                    }
                    
                    if (!isTimeUp) {
                        const selectedSet = new Set(selectedOptions);
                        const correctSet = new Set(question.correct);
                        if (selectedSet.size === correctSet.size) {
                            isCorrect = [...selectedSet].every(option => correctSet.has(option));
                        }
                    }
                }

                userAnswers[currentQuestionIndex] = { selected: selectedOptions, isCorrect };
                showAnswerResult(userAnswers[currentQuestionIndex]);
            }

            function showAnswerResult(userAnswer) {
                const question = quizQuestions[currentQuestionIndex];
                submitBtn.disabled = true;
                nextBtn.disabled = false;

                const matchingSelects = answersForm.querySelectorAll('select:not(#multi-select-box)');
                if (matchingSelects.length > 0) {
                    matchingSelects.forEach(select => {
                        select.disabled = true;
                        const part = select.dataset.part;
                        const correctValue = question.correct.find(c => Object.keys(c)[0] === part)[part];
                        if (select.value === correctValue) {
                            select.classList.add('correct');
                        } else {
                            select.classList.add('incorrect');
                        }
                    });
                } else if (answersForm.querySelector('#multi-select-box')) {
                    const multiSelect = answersForm.querySelector('#multi-select-box');
                    multiSelect.disabled = true;
                    Array.from(multiSelect.options).forEach(option => {
                        if (new Set(question.correct).has(option.value)) {
                            option.classList.add('correct');
                        } else if (userAnswer.selected.includes(option.value)) {
                            option.classList.add('incorrect');
                        }
                    });
                } else {
                    answersForm.querySelectorAll('input').forEach(input => {
                        input.disabled = true;
                        const label = document.getElementById(`label-answer-${input.id.split('-')[1]}`);
                        if (new Set(question.correct).has(input.value)) {
                            label.classList.add('correct');
                        } else if (input.checked) {
                            label.classList.add('incorrect');
                        }
                    });
                }
            }

            function showNextQuestion() {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    displayQuestion();
                } else {
                    showResults();
                }
            }

            function showPrevQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayQuestion();
                }
            }

            function showResults() {
                quizScreen.classList.add('hidden');
                resultsScreen.classList.remove('hidden');
                updateProgressData();
                const score = Object.values(userAnswers).filter(ans => ans.isCorrect).length;
                scoreEl.textContent = `Du hast ${score} von ${quizQuestions.length} Fragen richtig beantwortet.`;
            }

            function restartQuiz() {
                resultsScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                calculateAndDisplayProgress(); // Recalculate progress on restart to reflect latest answers
            }

            // Initial call
            initializeData();
            
            // Event Listeners
            modeFilterButtons.addEventListener('click', handleFilterClick);
            typeFilterButtons.addEventListener('click', handleFilterClick);
            sectionFilterButtons.addEventListener('click', handleFilterClick);
            questionCountFilterButtons.addEventListener('click', handleFilterClick);
            startQuizBtn.addEventListener('click', startQuiz);
            prevBtn.addEventListener('click', showPrevQuestion);
            nextBtn.addEventListener('click', showNextQuestion);
            submitBtn.addEventListener('click', () => submitAnswer());
            restartBtn.addEventListener('click', restartQuiz);
        });
    </script>
</body>
</html>
